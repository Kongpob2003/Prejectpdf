<div class="home-container">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo logo-box">
      <span class="material-icons logo-icon">picture_as_pdf</span>
      <span class="logo-text">MyPDF</span>
    </div>

    <ul>
      <li><span class="material-icons">home</span>หน้าหลัก</li>
      <li (click)="goProfile()"><span class="material-icons">person</span>ข้อมูลส่วนตัว</li>
      <li (click)="goCalender()"><span class="material-icons">calendar_month</span>ปฏิทิน</li>
      <li (click)="goAdddelete()"><span class="material-icons">group_add</span>เพิ่มลดผู้ใช้</li>
      <li (click)="goRelation()"><span class="material-icons">campaign</span>ประชาสัมพันธ์</li>
      <li (click)="goJae()"><span class="material-icons">description</span>JAE</li>
      <li (click)="goQualityassurance()">
        <span class="material-icons">verified</span>ประกันคุณภาพ
      </li>
      <li (click)="goCategory()"><span class="material-icons">category</span>หมวดหมู่</li>
      <li class="logout" (click)="logout()">
        <span class="material-icons">logout</span>ออกจากระบบ
      </li>
    </ul>
  </aside>

  <!-- Toast -->
  <div class="success-toast" *ngIf="uploadSuccess">✅ อัปโหลดเอกสารสำเร็จ</div>

  <!-- Content -->
  <main class="content">
    <div class="top-bar">
      <div class="search-box">
        <span class="material-icons search-icon">search</span>
        <input type="text" placeholder="ค้นหาชื่อไฟล์" [(ngModel)]="searchText" />
      </div>

      <!-- ✅ USER INFO -->
      <div class="user-info" *ngIf="user">
        <span class="material-icons user-icon">account_circle</span>
        <div class="user-text">
          <div class="user-name">{{ user.username }}</div>
          <div class="user-role">{{ displayRole }}</div>
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <!-- Summary -->
    <div class="summary-row">
      <div class="summary-box">
        <span class="material-icons summary-icon">description</span>
        <div class="summary-text">
          <p>{{ document.length }} ไฟล์</p>
          <h3>เอกสารทั้งหมด</h3>
        </div>
      </div>

      <button class="upload-btn" (click)="openUpload()">อัปโหลดไฟล์</button>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button [class.active]="activeTab === 'all'" (click)="activeTab = 'all'">ทั้งหมด</button>
      <button [class.active]="activeTab === 'sent'" (click)="activeTab = 'sent'">ส่งแล้ว</button>
      <button [class.active]="activeTab === 'unsent'" (click)="activeTab = 'unsent'">
        ยังไม่ส่ง
      </button>
    </div>

    <!-- Files -->
    <div class="files-box">
      <div class="file-grid">
        <div class="file-card" *ngFor="let file of filteredFiles" (click)="openModal(file)">
          <span class="material-icons delete-icon" (click)="deleteFile($event, file)">delete</span>
          <span class="material-icons file-icon">picture_as_pdf</span>
          <div class="file-name">{{ file.file_name }}</div>
          <span class="status-badge" [ngClass]="file.statue === '1' ? 'sent' : 'unsent'">
            {{ file.statue === '1' ? 'ส่งแล้ว' : 'ยังไม่ส่ง' }}
          </span>
        </div>
      </div>
    </div>
  </main>
</div>

<div
  class="modal-backdrop"
  *ngIf="showModal || showSendTeacher || showUpload"
  (click)="closeAllModals()"
>
  <!-- ================= PREVIEW MODAL ================= -->
  <div
    class="modal-box"
    *ngIf="showModal"
    (click)="$event.stopPropagation()"
  >
    <h3>{{ selectedFile?.file_name }}</h3>

    <iframe
      *ngIf="safeFileUrl"
      class="pdf-preview"
      [src]="safeFileUrl"
    ></iframe>

    <div class="upload-actions">
      <button class="btn-cancel" (click)="closeAllModals()">ปิด</button>
      <button
        class="btn-submit"
        *ngIf="selectedFile?.statue === '0'"
        (click)="openSendTeacher()"
      >
        ส่งให้อาจารย์
      </button>
    </div>
  </div>

  <!-- ================= SEND TEACHER MODAL ================= -->
  <div
    class="modal-box"
    *ngIf="showSendTeacher"
    (click)="$event.stopPropagation()"
  >
    <h3>หัวเรื่องเอกสาร</h3>
    <input
      type="text"
      class="subject-input"
      placeholder="พิมพ์หัวเรื่อง..."
      [(ngModel)]="sendSubject"
    />

    <!-- หมวดหมู่ -->
    <div class="section-header">
      <h3>เลือกหมวดหมู่เอกสาร</h3>
      <div class="section-actions">
        <button (click)="selectAllCategories()">เลือกทั้งหมด</button>
        <button class="clear" (click)="clearAllCategories()">ล้าง</button>
      </div>
    </div>

    <div class="category-grid">
      <div
        class="category-card"
        *ngFor="let c of category"
        (click)="toggleCategory(c.category_id)"
        [class.selected]="selectedCategories.includes(c.category_id)"
      >

        <div class="category-name">{{ c.Name }}</div>
      </div>
    </div>

    <!-- อาจารย์ -->
    <div class="section-header">
      <h3>เลือกอาจารย์</h3>
      <div class="section-actions">
        <button (click)="selectAllTeachers()">เลือกทั้งหมด</button>
        <button class="clear" (click)="clearAllTeachers()">ล้าง</button>
      </div>
    </div>

    <div class="teacher-grid">
      <div
        class="teacher-card"
        *ngFor="let t of person"
        (click)="toggleTeacher(t.uid)"
        [class.selected]="selectedTeachers.includes(t.uid)"
      >
        <span class="material-icons">person</span>
        {{ t.username }}
      </div>
    </div>

    <div class="upload-actions">
      <button class="btn-cancel" (click)="closeAllModals()">ยกเลิก</button>
      <button
        class="btn-submit"
        [disabled]="
          !sendSubject ||
          selectedTeachers.length === 0 ||
          selectedCategories.length === 0
        "
        (click)="sendToTeacher()"
      >
        ส่งเอกสาร
      </button>
    </div>
  </div>

  <!-- ================= UPLOAD MODAL ================= -->
  <div
    class="upload-modal"
    *ngIf="showUpload"
    (click)="$event.stopPropagation()"
  >
    <h3>อัปโหลดเอกสาร</h3>

    <div class="upload-form">
      <label>หัวเรื่อง</label>
      <input type="text" [(ngModel)]="uploadTitle" readonly />

      <label>ไฟล์ PDF</label>
      <label class="file-upload">
        <span class="material-icons">picture_as_pdf</span>
        <div>คลิกเพื่อเลือกไฟล์</div>
        <input
          type="file"
          accept="application/pdf"
          hidden
          (change)="onFileSelected($event)"
        />
        <div class="file-name-preview" *ngIf="uploadFileName">
          {{ uploadFileName }}
        </div>
      </label>

      <div class="upload-actions">
        <button class="btn-cancel" (click)="closeAllModals()">ยกเลิก</button>
        <button
          class="btn-submit"
          [disabled]="!uploadFile"
          (click)="submitUpload()"
        >
          อัปโหลด
        </button>
      </div>
    </div>
  </div>
</div>
